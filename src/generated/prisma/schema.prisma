generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts  Account[]
  sessions  Session[]
  favorites Favorite[]
  role      UserRole   @default(PATRON)
}

enum UserRole {
  PATRON
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Owner {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  password          String
  phone             String?
  emailVerified     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  allowFreeListings Boolean   @default(false)

  bars             Bar[]
  subscription     Subscription?
  promoRedemptions PromoRedemption[]
  role             OwnerRole         @default(OWNER)
}

enum OwnerRole {
  OWNER
  ADMIN
}

model Subscription {
  id                   String             @id @default(cuid())
  ownerId              String             @unique
  plan                 SubscriptionPlan
  status               SubscriptionStatus @default(ACTIVE)
  paypalCustomerId     String?
  paypalSubscriptionId String?
  priceId              String?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  owner Owner @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

enum SubscriptionPlan {
  MONTHLY
  SIX_MONTH
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  INCOMPLETE
  PAST_DUE
  CANCELED
  PAUSED
}

model Bar {
  id                     String    @id @default(cuid())
  ownerId                String
  name                   String
  slug                   String    @unique
  description            String?   @db.Text
  address                String
  city                   String
  cityNormalized         String
  state                  String
  zipCode                String
  neighborhood           String?
  neighborhoodNormalized String?
  latitude               Float
  longitude              Float
  phone                  String?
  website                String?
  logo                   String?
  photos                 String[]  @default([])
  hours                  Json?
  isActive               Boolean   @default(true)
  isPublished            Boolean   @default(false)
  publishedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  profileViews           Int       @default(0)
  searchAppearances      Int       @default(0)

  owner     Owner          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  offerings Offering[]
  events    Event[]
  favorites Favorite[]
  analytics BarAnalytics[]
  clicks    BarClick[]
  badges    BarBadge[]

  @@index([cityNormalized])
  @@index([neighborhoodNormalized])
  @@index([latitude, longitude])
  @@index([isActive])
  @@index([isPublished])
}

model Offering {
  id               String     @id @default(cuid())
  barId            String
  dayOfWeek        Int
  category         String
  customTitle      String?
  description      String?    @db.Text
  startTime        String
  endTime          String?
  recurrence       Recurrence @default(WEEKLY)
  startDate        DateTime?
  endDate          DateTime?
  tags             String[]   @default([])
  coverCharge      Decimal?   @db.Decimal(10, 2)
  prize            String?
  ageRestriction   Int?
  isActive         Boolean    @default(true)
  isSpecial        Boolean    @default(false)
  isNew            Boolean    @default(true)
  specialExpiresAt DateTime?
  newUntil         DateTime?
  expiresAt        DateTime?
  clickCount       Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  bar Bar @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@index([barId])
  @@index([dayOfWeek])
  @@index([category])
  @@index([isActive])
  @@index([isSpecial])
  @@index([isNew])
}

enum Recurrence {
  ONE_TIME
  WEEKLY
  MONTHLY
}

model Event {
  id               String      @id @default(cuid())
  barId            String
  title            String
  description      String?     @db.Text
  category         String?
  startDate        DateTime
  endDate          DateTime?
  startTime        String
  endTime          String?
  isRecurring      Boolean     @default(false)
  recurrenceRule   String?
  recurrence       Recurrence? @default(ONE_TIME)
  tags             String[]    @default([])
  isActive         Boolean     @default(true)
  isSpecial        Boolean     @default(true)
  isNew            Boolean     @default(true)
  specialExpiresAt DateTime?
  newUntil         DateTime?
  autoExpire       Boolean     @default(true)
  coverCharge      Decimal?    @db.Decimal(10, 2)
  prize            String?
  ageRestriction   Int?
  clickCount       Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  bar Bar @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@index([barId])
  @@index([startDate])
  @@index([isSpecial])
  @@index([isNew])
  @@index([isActive])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  barId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  bar  Bar  @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@unique([userId, barId])
}

model ActivityCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  icon        String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model PromoCode {
  id             String            @id @default(cuid())
  code           String            @unique
  description    String?
  isActive       Boolean           @default(true)
  maxRedemptions Int?
  usedCount      Int               @default(0)
  expiresAt      DateTime?
  grantPlan      SubscriptionPlan?
  grantMonths    Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  redemptions PromoRedemption[]
}

model PromoRedemption {
  id          String   @id @default(cuid())
  promoCodeId String
  ownerId     String
  redeemedAt  DateTime @default(now())

  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  owner     Owner     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([promoCodeId, ownerId])
}

model BarAnalytics {
  id            String   @id @default(cuid())
  barId         String
  date          DateTime
  dayOfWeek     Int // 0 = Sunday, 6 = Saturday
  profileViews  Int      @default(0)
  profileClicks Int      @default(0)
  searchAppears Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bar Bar @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@unique([barId, date])
  @@index([barId])
  @@index([date])
  @@index([dayOfWeek])
}

model SearchQuery {
  id        String   @id @default(cuid())
  query     String   @db.Text
  location  String?
  category  String?
  dayOfWeek Int // 0 = Sunday, 6 = Saturday
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([query, location, category])
  @@index([query])
  @@index([dayOfWeek])
  @@index([count])
}

model BarClick {
  id        String   @id @default(cuid())
  barId     String
  source    String // 'search', 'map', 'favorites', 'direct'
  query     String? // search query if from search
  dayOfWeek Int // 0 = Sunday, 6 = Saturday
  createdAt DateTime @default(now())

  bar Bar @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@index([barId])
  @@index([source])
  @@index([dayOfWeek])
  @@index([createdAt])
}

model Badge {
  id          String        @id @default(cuid())
  key         String        @unique // e.g., 'founding_member', 'rising_star'
  name        String // Display name
  description String        @db.Text
  icon        String // Emoji or icon identifier
  tier        BadgeTier     @default(BRONZE)
  category    BadgeCategory
  requirement String        @db.Text // JSON string describing requirements
  color       String // Tailwind color class like 'blue', 'emerald', 'purple'
  isActive    Boolean       @default(true)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  barBadges BarBadge[]
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum BadgeCategory {
  FOUNDING
  ENGAGEMENT
  CONTENT
  PATRON_LOVE
  ACHIEVEMENT
  COMMUNITY
  SEASONAL
}

model BarBadge {
  id        String   @id @default(cuid())
  barId     String
  badgeKey  String
  awardedAt DateTime @default(now())
  progress  Json? // Track progress towards next tier
  metadata  Json? // Additional data like which month/week earned

  bar   Bar   @relation(fields: [barId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeKey], references: [key], onDelete: Cascade)

  @@unique([barId, badgeKey])
  @@index([barId])
  @@index([badgeKey])
  @@index([awardedAt])
}
